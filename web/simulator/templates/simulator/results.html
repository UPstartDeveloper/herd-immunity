{% extends "simulator/base.html" %}

<!-- user sees results of the simulation -->
{% block content %}

    <h1>And the Results Are In!</h1>
    <h2>Did your population survive the epidemic?</h2>
    <hr
    <!-- display initial settings of simulation -->
    <h3>Initial Conditions</h3>
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <strong>Population Stats:</strong>
                <ul>
                    <li>
                        Time Step 0
                    </li>
                    <li>
                        Population Size: {{ experiment.population_size }}
                    </li>
                    <li>
                        Initially Infected: {{ experiment.initial_infected }}
                    </li>
                    <li>
                        Vaccinated Percentage: {{ experiment.vaccination_percent }}
                    </li>
                    <li>
                        Dead: 0
                    </li>
                </ul>
            </div>
            <div class="col-md-6">
                <strong>Virus Info:</strong>
                <ul>
                    <li>
                        Name: {{ experiment.virus_name }}
                    </li>
                    <li>
                        Reproductive Rate: {{ experiment.reproductive_rate }}
                    </li>
                    <li>
                        Mortality Rate: {{ experiment.mortality_chance }}
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <!-- display time steps -->
    <hr>
    <h3>Progression</h3>
    <p>What happened at each stage of the epidemic?</p>
    <!-- Table of Time Steps -->
    <table class="table">
        <thead class="thead-dark">
            <tr>
                <th scope="col">Step #</th>
                <th scope="col">Total Infected</th>
                <th scope="col">Current Infected</th>
                <th scope="col">Vaccination Percentage</th>
                <th scope="col">Dead</th>
                <th scope="col">Total Vaccinated</th>
                <th scope="col">Total Alive</th>
                <th scope="col">Unifected individuals</th>
                <th scope="col">Uninteracted individuals</th>
            </tr>
         </thead>
         <tbody>
            {% for time_step in time_steps %}
                <tr>
                    <th scope="row">{{ time_step.step_id }}</th>
                    <td>{{ time_step.total_infected }}</td>
                    <td>{{ time_step.current_infected }}</td>
                    <td>{{ time_step.vaccinated_population }}</td>
                    <td>{{ time_step.dead }}</td>
                    <td>{{ time_step.total_vaccinated }}</td>
                    <td>{{ time_step.alive  }}</td>
                    <td>{{ time_step.uninfected }}</td>
                    <td>{{ time_step.uninteracted }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <hr>
    <h3>Final Results</h3>
    <p>Here is the breakdown of the population, at the end of the experiment:</p>
    <h5 class="text-center">Herd Immunity Resistance to {{ experiment.virus_name }} Outbreak</h5>
    <!-- Display of Pie Chart -->
    <!--{#<div url-endpoint="{% url 'api:data' experiment.id %}">#}-->
        <canvas id="pieChart" width="400" height="400"></canvas>
        <script>
            $(document).ready(function(){
                {% block jquery %}
                // get the data on the TimeStep from the API, using AJAX
                var endpoint = '/api/{{experiment.id}}/chart/data/'
                var plotData = [ ]
                var plotLabels = [];
                $.ajax({
                    method: "GET",
                    url: endpoint,
                    success: function(data){
                        plotLabels = data.labels
                        plotData = data.pop_sizes
                        pieChart()
                    },
                    error: function(error_data){
                        console.log(error_data)
                    }
                })
                // make pie chart
                function pieChart() {
                    var ctx = document.getElementById('pieChart').getContext('2d');
                    var pieChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: plotLabels,
                        datasets: [{
                            label: '# of People',
                            data: plotData,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.2)',
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(255, 206, 86, 0.2)',
                                'rgba(75, 192, 192, 0.2)',
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }]
                        }
                    }
                    });
                }
                {% endblock %}
            })
        </script>
    <!--</div>-->
    <hr>
    <h3>Notes:</h3>
    <ol>
        <li>
            "Uninteracted": meaning individuals alive, not vaccinated, and not infected.
        </li>
        <li>
            "Total infected": although displayed in each time step, this value is<br>
             culmulative for the entire duration of the experiment.
        </li>
    </ol>
    <br>
    <!-- link to start another simulation -->
    <div class="offset-md-10">
        <a href="/" class="btn btn-primary">Back to Home</a>
    </div>
    <br><br>

{% endblock %}
